\renewcommand{\chapid}{pedant}

% Chapter specific commands:

% rules for my math notation, in case I get confused
% galaxies i, redshifts j, combinations k
% N galaxies out of N_tot galaxies
% dagger for "truth", tilde for interim, prime for proposed/different
% prior info I_[informative subscript]

\chapter{ If stacking is wrong, why does it feel so right? \chaplabel{pedant} }

This \paper\ concerns the method by which one obtains the distribution of galaxy redshifts from catalogs of \pzpdf s by addressing why established methodologies appear correct despite being invalid, work inspired by conversations with Phil Marshall in response to \citet{gruen_sumzz_2017} during the summer of 2017 that was refined by further discussions with Boris Leistedt at the \textit{Statistical Challenges in Large-scale Structure in the Era of \lsst} Workshop at Oxford University in spring 2018.

\section*{Chapter abstract}

The constraining power of current and upcoming telescope missions is contingent on our ability to obtain redshift estimates for large numbers of faint galaxies.
In the absence of spectroscopic redshifts, unreliable photometric redshift point estimates (photo-$z$s) have been superceded by photo-$z$ probability density functions (PDFs) that encapsulate their nontrivial uncertainties.
Initial applications of photo-$z$ PDFs in weak gravitational lensing studies of cosmology have employed naive methodologies for obtaining the redshift distribution function $N(z)$.
Though computationally straightforward, such techniques violate the laws of probability, triggering a proliferation of mathematically self-consistent models of varying complexity answering the question, ``What is the right way to obtain the redshift distribution function $N(z)$ from a catalog of photometric redshift PDFs?''
However, adoption of these principled models has been slow, perhaps due to a gap in understanding between those developing the methods and those applying them to real data.
This letter aims to bridge that gap by addressing the contrapositive of the more common presentation of such models, answering the question, ``Under what conditions do traditional stacking methods recover the true redshift distribution function $N(z)$?''

\section{Background}
\sectlabel{sec:intro}

Though it is at this point well known that estimating the redshift distribution \Nz\ via stacking, defined by Equation~\ref{intro:eq:eqn:stack}, is incorrect \citep{leistedt_hierarchical_2016, malz_chippr_nodate}, even modern analyses still employ the stacked estimator rather than a principled approach \citep{sheldon_photometric_2012, hoyle_dark_2017}.
In this instance, the resistance to change goes beyond simple inertia and the technical challenges associated with more sophisticated inference methods.
Stacking is bolstered by pervasive misunderstandings about the causal structure of the problem and \pzpdf s as probabilistic objects overall \citep{gruen_sumzz_2017, jarvis_rmjarvis_2018, malz_aimalz_2018}.

\aim{I might not be distinguishing definitions, propositions, lemmas, and theorems properly and need to consult with someone more familiar with this formalism.}
\aim{Also, the mathematical notation in here isn't entirely self-consistent yet, sorry.}

We first establish some basic definitions by considering the chance that a single galaxy $i$ has a given redshift $z'$.

\begin{definition}\label{def:binarystatespace}
	The \textit{state space} $\Omega(z_{i}) = \{z_{i} = z', z_{i} = \lnot z'\}$ of a particular galaxy's redshift $z_{i}$ can be broken down into two states, that of redshift equal to $z'$ and that of any other redshift $\lnot z'$.
\end{definition}

\begin{definition}\label{def:disjoint}
	The elements of the state space are \textit{disjoint} if one occurring means that all others do not occur; our single galaxy cannot have both $z_{i} = z'$ and $z_{i} = \lnot z'$.
\end{definition}

\begin{definition}\label{def:pdens}
	The \textit{probability density function (PDF)} $\pr{z_{i}} \geq 0$ is the chance that a galaxy's redshift $z_{i}$ takes any possible value, and the PDF may be parameterized by some function $f(z_{i}; \theta)$ over redshifts $z_{i}$ with parameters $\theta$.
	The PDF can be evaluated at any specific redshift $z'$ to give the chance $\pr{z'}$ that the galaxy has that particular redshift, which in terms of $f(z_{i}; \theta)$ is $\lim_{\varepsilon \to 0} \int_{z' - \varepsilon}^{z' + \varepsilon} f(z_{i}; \ndphi) \mathrm{d}z_{i}$.
\end{definition}

\begin{definition}\label{def:normalization}
	A probability density must satisfy the \textit{normalization} condition $\integral{\pr{z_{i}}}{z_{i}} = 1$.
	Combined with Definition \ref{def:disjoint}, the normalization condition is equivalent to $\pr{z_{i} = z'} + \pr{z_{i} = \lnot z'} = 1$ for our single galaxy $i$ and reference redshift $z'$.
\end{definition}

These definitions pertain to the redshift of a single galaxy $i$, but this \paper concerns the distribution \Nz\ of redshifts of an ensemble of $N$ galaxies.
For a single redshift $z'$, there may be $\Omega(K) = \{K = 0, \dots, K = N\}$ galaxies with that redshift, so the state space $\Omega(K)$ of $K$ has $N + 1$ elements.

\begin{definition}\label{def:independence}
	The probability of multiple \textit{statistically independent} events occurring is the product of the probabilities of the individual events.
	For example, in a universe with $N = 2$ galaxies $i = 1, 2$, the probability that each takes a specific redshift is $\pr{z_{1} = z_{1}' \cap z_{2} = z_{2}'} = \pr{z_{1} = z_{1}'} \pr{z_{2} = z_{2}'}$ if the redshift of one is not causally dependent on the redshift of the other, which is denoted as $z_{1} \perp z_{2}$.
	If $z'_{1} = z'_{2} = z'$, then this probability is also equal to $\pr{K = 2}$.
\end{definition}

Equation~\ref{intro:eq:eqn:stack} can only hold if $\pr{z_{1} = z' \cap z_{2} = z'} = \pr{z_{1} = z'} + \pr{z_{2} = z'}$, which does not directly follow from any combination of the above definitions.

\begin{proposition}\label{prp:union}
	The probability that either of two independent events occur is $\pr{z_{1} = z_{1}' \cup z_{2} = z_{2}'} = \pr{z_{1} = z_{1}'} \pr{z_{2} = \lnot z_{2}'} + \pr{z_{1} = \lnot z_{1}'} \pr{z_{2} = z_{2}'} + \pr{z_{1} = z_{1}'} \pr{z_{2} = z_{2}'} = \pr{z_{1} = z_{1}} (1 - \pr{z_{2} = z_{2}'}) + (1 - \pr{z_{1} = z_{1}'}) \pr{z_{2} = z_{2}'} + \pr{z_{1} = z_{1}'} \pr{z_{2} = z_{2}'} = 1 - \pr{z_{1} = \lnot z_{1}' \cap z_{2} = \lnot z_{2}'}$.
\end{proposition}
\begin{proof}
	Combining Definitions \ref{def:normalization} and \ref{def:independence} yields the above expressions.
\end{proof}

\aim{Should I include the proof by induction that follows from Definition \ref{def:independence} or leave it as an exercise for the reader?}

%More generally, we can quantify \Nz\ with a summary statistic $\ndphi$, which under some function $N(z) = f(z; \ndphi)$ provides the number of galaxies \Nz\ at a redshift $z$.
%The redshift distribution itself can be used to define a probability density $n(z) \equiv \pr{z \gvn \ndphi} = N(z) / N_{tot}$ of finding a galaxy at a given redshift under the parameter $\ndphi$.
%Thus the state space of $\pr{\ndphi}$ depends on the function $f$, but the state space of $\pr{z \gvn \ndphi}$ must only satisfy Definitions \ref{def:pdens} and \ref{def:normalization}.

\begin{definition}\label{def:expected}
	The expected value $\langle z \rangle = \integral{z \pr{z}}{z}$ for a continuous random variable $z$.
\end{definition}

Because the stacked estimator of the redshift distribution given in Equation~\ref{intro:eq:eqn:stack} yields a single value $\hat{K}$ for $K$ rather than the probability distribution $\pr{K}$, we'll work with the expected value so we can compare apples to apples.

\begin{lemma}\label{lem:expectednz}
	As a discrete random variable, the expected value $\langle K \rangle$ of $K$ is $\sum_{K = 0}^{N} K \pr{K}$.
\end{lemma}

However, all we have to work with are the members of the catalog of \pzpdf s, $\{\pr{z_{i}}\}$, not $\pr{K}$.
\Sect{sec:pedanticmath} connects our \pzpdf s to the distribution of possible values $K$ for $N(z')$.

\section{Derivation}
\sectlabel{sec:pedanticmath}

The following proofs establish the relationship between a catalog of individual \pzpdf s and the redshift distribution from a combinatorial perspective.
Though it doesn't matter for our science, let's consider all possible orderings of the whole set of $N$ galaxies $i = 1, \dots, N$.

\begin{definition}\label{def:permutations}
	The number of possible orderings of the $N$ galaxies is $N! = N \cdot (N - 1) \cdot \dots \cdot 1$.
\end{definition}

\begin{lemma}\label{lem:combinations}
	The number of possible unordered subsets of $K$ galaxies that can be selected from a set of $N \geq K$ galaxies is $\binom{N}{K} \equiv \frac{N!}{K! (N - K)!}$.
	\aim{Should I cut this basic proof out?}
\end{lemma}
\begin{proof}
	If there are $K$ galaxies with redshift $z'$, we can think of them as the first $K$ in an ordering of the full $N$ galaxies.
	We expect that many of the $N!$ orderings can result in the same ordered set of $K$ at the beginning of the ordered list.
	Not only do we not care about the ordering within the first $K$ galaxies, but we also don't care about the ordering of the last $N - K$ galaxies.
	Thus there are $C \equiv \frac{N!}{K! (N - K)!}$ combinations of the first $K$ galaxies, defining a set $[N]^{K} = \{S^{K}_{j}\}$ of $|[N]^{K}| = C$ possible sets $S^{K}_{j}$ of galaxies with $|S^{K}_{j}| = K$ to consider.
\end{proof}

Since galaxies have true redshifts in nature, there is one set $S^{K^{\dagger}}_{j^{\dagger}}$ out of the set $[N]^{K}$ of all sets $S^{K^{\dagger}}_{j}$ with $|S^{K^{\dagger}}_{j}| = K^{\dagger}$ galaxies that contains all galaxies that really do have redshift $z'$ and no galaxies that have redshift $\lnot z'$, for every possible redshift $z'$.
There are of course also sets $S^{K^{\dagger}}_{j \neq j^{\dagger}}$ of $0 < K = K^{\dagger} < N$ galaxies that are not the exact set of galaxies that have true redshift $z'$, but in our two-redshift universe, we only need to recover from our \pzpdf\ catalog the number $K^{\dagger}$ of galaxies with redshift $z'$, not which galaxies are in $S^{K^{\dagger}}_{k^{\dagger}}$. 
And there are even more sets $S^{K}_{j}$ of $|S^{K}_{j}| = K \neq K^{\dagger}$ galaxies that do not even have the same number of members as the true number $K^{\dagger}$ of galaxies with redshift $z'$.

We are now prepared to consider the probability $\pr{K'}$ that $N(z')$ takes any particular value $K'$ at a fixed $z'$.

%\begin{definition}
%	\aim{define orderings above and turn this into a proposition?}
%	The number of possible orderings of all $\comb{N_{tot}}{N}$ subsets of $N$ galaxies out of a set of $N_{tot} \geq N$ is $\perm{N_{tot}}{N} \equiv \frac{N_{tot}!}{(N_{tot}-N)!} = N!\comb{N_{tot}}{N}$.
%\end{definition}

\subsection{A universe of identical galaxies}
\sectlabel{sec:tworedshift}

It is helpful to consider the special case in which all galaxies have the same \pzpdf\ $\pr{z_{i}} = \pr{z}$.

\begin{theorem}
	In a two-redshift universe in which all galaxies have the same \pzpdf with probability $\pr{z'} = \phi$ of having redshift $z'$, the probability mass function over the redshift distribution is
	\begin{equation}
	\eqlabel{eqn:binomial}
	\pr{K} = \binom{N}{K} \phi^{K} (1 - \phi)^{N - K} .
	\end{equation}
\end{theorem}

\begin{proof}
If there are only two possible redshifts, those of Definition \ref{def:binarystatespace}, then the problem is equivalent to that of counting $K$ successes after flipping a single coin with $\pr{\mathrm{success}} = \phi$ a total of $N$ times.
The $N$ coin flips build a set $S^{K}_{j}$ of $K$ galaxies with redshift $z'$ and $S^{N-K}_{j}$ of $N - K$ galaxies with redshift $\lnot z$'.
If we want the probability of $K$ successes, we sum over the set $[N]^{K}$ all combinations of galaxies that could define these sets.
Bearing in mind that our galaxies have $\pr{\lnot z'} = 1 - \phi$, due to Definitions \ref{def:binarystatespace} and \ref{def:disjoint}, the probability of $K$ galaxies having redshift $z'$ is given by the binomial theorem, which is \Eq{eqn:binomial}.
\end{proof}

We may generalize the two-redshift universe to a many-redshift universe by considering the extension of the binomial theorem to the birthday problem, which asks for the probability that $K$ people in a room of $N$ people share the same birthday $z'$.
We will, however, proceed by considering only one redshift $z'$ at a time to maintain the simple state space; the proof of the birthday problem case is left as an exercise for the reader.
%the birthday problem is solved by $p(N_{z}) = 1 - p(z)^{N_{tot}} \times \perm{N_{tot}}{N_{z}}$
\aim{Should I include the proof by induction or is it okay to assert that it works?}

\subsection{A universe of unique galaxies}
\sectlabel{sec:unique}

Of course galaxies do not share the same \pzpdf; the \pzpdf s differ because the photometry $\data_{i}$ differs.
%Now, each galaxy $i$ has $p(z \gvn \data_{i})$.
%\aim{Figure: isolating one redshift slice of $N(z)$}
\begin{lemma}\label{lem:unique}
	The probability that $N(z')$ takes the value $K$ is 
	\begin{align}
	\eqlabel{eqn:general}
	\pr{K} &= \sum_{j}^{N! / K! (N - K)!} \left[ \prod_{i \in S^{K}_{j}}^{K} \pr{z_{i} = z'} \prod_{i \notin S^{K}_{j}}^{N - K} 1 - \pr{z_{i} = z'} \right] .
	\end{align}
\end{lemma}
\begin{proof}
	By Definition \ref{def:independence}, the probability of obtaining set $S^{K}_{j}$ is the product of the probability that all the galaxies in that set have redshift $z'$ and the probability that all the galaxies outside that set have redshift $\lnot z'$.
	By Definition \ref{def:independence} again, the probability that all the galaxies in that set have redshift $z'$ is the product of the $K$ probabilities $\{\pr{z_{i} = z'}\}_{i \in S^{K}_{j}}$ of the galaxies in $S^{K}_{j}$, and the probability that all the galaxies outside that set have redshift $\lnot z'$ is the product of the $N - K$ probabilities $\{\pr{z_{i} \neq z'}\}_{i \notin S^{K}_{j}}$.
	By Definition \ref{def:binarystatespace}, $\pr{z_{i} \neq z'} = \pr{z_{i} = \lnot z'} = 1 - \pr{z_{i} = z'}$.
	So the probability $\pr{S^{K}_{j}}$ of a single combination $S^{K}_{j}$ is $\prod_{i \in S^{K}_{j}} \pr{z_{i} = z'} \prod_{i \notin S^{K}_{j}} 1 - \pr{z_{i} = z'}$.
	Invoking Definition \ref{def:disjoint}, we know that $\pr{K} = \sum_{j}^{N! / K! (N - K)!} \pr{S^{K}_{j}}$.
\end{proof}
%\aim{Figure: posterior samples of $N_{z}$ for that slice}

\section{Results}
\sectlabel{sec:pedanticres}

\begin{theorem}\label{thm:general}
	The expected value of $K$ in the general case of a universe of unique galaxies is given by
	\begin{align}
	\eqlabel{eqn:complete}
	\langle N_{z} \rangle &= \sum_{K = 0}^{N} K \sum_{j}^{N! / K! (N - K)!} \left[ \prod_{i \in S^{K}_{j}}^{K} \pr{z_{i} = z'} \prod_{i \in S^{K}_{j}}^{N - K} 1 - \pr{z_{i} = z'} \right].
	\end{align}
\end{theorem}
\begin{proof}
	Apply Definition \ref{def:expected} to Lemma \ref{lem:unique} to arrive at \Eq{eqn:complete}.
\end{proof}

In \Sect{sec:informative} and \Sect{sec:uninformative}, we will correct the gross abuse of notation that is ``$\pr{z_{i}}$'' by revealing its true nature and propagating that through \Eq{eqn:complete}.
By confronting what this ubiquitous notation sweeps under the rug, we will identify the only conditions under which Equation~\ref{intro:eq:eqn:stack} can yield a result consistent with \Eq{eqn:complete}.
%\begin{itemize}
%	\item \Pzpdf s are posteriors conditioned on data $\pr{z \gvn \data_{i}}$; referring to  is a gross abuse of notation that doesn't even make sense because the domain of $z$ is the same for any galaxy $i$.
%	\item \Pzpdf s are also conditioned on the prior information, $\tilde{N}$, used to derive them, such as a template library or training set, as well as the method used to combine this information with the data of each galaxy.
%%	\item There is also an implicit prior $I_{M}$ due to the method used to combine $I_{P}$ and $\data_{i}$ to yield an estimated posterior, $\pr{z \gvn \data_{i}, I_{P}, I_{M}}$.
%\end{itemize}
%These points will be expanded upon Here I explore what assumptions must hold for \Eq{eqn:complete} to be equivalent to Equation~\ref{intro:eq:eqn:stack}.

\subsection{Perfectly informative data}
\sectlabel{sec:informative}

Let's investigate what differentiates \pzpdf s for each galaxy.
The redshifts are always defined over the same dimension, but what's different is the photometric data $\data_{i}$ for each galaxy.
The way that enters into the \pzpdf\ is that $\pr{z_{i}}$ is really a horrible shorthand for $\pr{z \gvn \data_{i}}$, the probability that a galaxy has each redshift conditional on the data observed.
From this point on, we'll use the full form of Equation~\ref{intro:eq:eqn:stack},
\begin{align}
\eqlabel{eqn:stackwithdata}
\hat{N}(z) &= \sum_{i = 0}^{N} \pr{z \gvn \data_{i}} .
\end{align}
It is important to note here what is wrong with \Eq{eqn:stackwithdata}.
While it may look like \Eq{eqn:normalize}, we can never integrate over the quantity on the right side of a conditional; there is only a mathematical framework for integrating over the quantity on the left side of a conditional \citep{hogg_data_2012}.

If the data is perfectly informative, then $\pr{z \gvn \data_{i}} = \delta(z,\ z_{i}^{\dagger})$, where $z_{i}^{\dagger}$ is the true redshift of galaxy $i$.
\Pzpdf s are not delta functions because the data are inherently noisy and because our model for the relationship between photometry and redshift is imperfect, as was covered in Figure~\ref{intro:fig:fig:pedagogical_scatter}.
However, if we wanted to write the PDF of a spectroscopic redshift, it could be considered a delta function like this.
We know that \Eq{eqn:stackwithdata} works in this case and will now answer whether \Eq{eqn:complete} yields an equivalent result in the idealized case of spectroscopic-quality observations.

\begin{theorem}
	\label{thm:informative}
	The mathematically valid $\langle N(z') \rangle$ asymptotically approaches the result of stacking and the true number $NK^{\dagger}$ of galaxies with redshift $z'$ under perfectly informative photometry, i.e. $\pr{z' \gvn \data_{i}} = \delta(z',\ z^{\dagger}_{i})$.
\end{theorem}
\begin{proof}
	First, we replace all instances of $\pr{z_{i}}$ in \Eq{eqn:complete} with $\pr{z \gvn \data_{i}}$, yielding
	\begin{align}
	\eqlabel{eqn:proofwithdata1}
	\langle N(z') \rangle &= \sum_{K = 0}^{N} K \sum_{j}^{N! / K! (N - K)!} \left[ \prod_{i \in S^{K}_{j}} \pr{z' \gvn \data_{i}} \prod_{i \notin S^{K}_{j}} 1 - \pr{z' \gvn \data_{i}} \right]
	\end{align}
	For perfectly informative data, each of these $\pr{z \gvn \data_{i}}$ becomes $\delta(z,\ z^{\dagger}_{i})$, making \Eq{eqn:proofwithdata1} into
	\begin{align}
	\eqlabel{eqn:proofwithdata2}
	\langle N(z') \rangle &= \sum_{K = 0}^{N} K \sum_{j}^{N! / K! (N - K)!} \left[ \prod_{i \in S^{K}_{j}} \delta(z', z^{\dagger}_{i}) \prod_{i \notin S^{K}_{j}} 1 - \delta(z', z^{\dagger}_{i}) \right]
	\end{align}
	Each of the delta function terms in \Eq{eqn:proofwithdata2} will be $1$ when $z' = z^{\dagger}_{i}$ and $0$ otherwise.
	There is only one combination $j^{\dagger}$ that will result in a nonzero product, the one whose $S^{K}_{j}$ contains all $K = K^{\dagger}$ galaxies with $z^{\dagger}_{i} = z'$ and no interlopers with $z^{\dagger}_{i} \neq z'$.
	Thus there is only one nonzero term in the entire sum, and it can only correspond to 
	\begin{align}
	\eqlabel{eqn:proofwithdata3}
	\langle N(z') \rangle &= K^{\dagger} \left[ \prod_{i \in S^{K}_{j^{\dagger}}} \delta(z', z^{\dagger}_{i}) \prod_{i \notin S^{K}_{j^{\dagger}}} 1 - \delta(z', z^{\dagger}_{i}) \right]
	\end{align}
	Since the entire bracketed quantity in \Eq{eqn:proofwithdata3} is $1$, we arrive at the desired $\langle N(z') \rangle = K^{\dagger}$, the same as what stacking yields.
\end{proof}

\aim{Perhaps I should write out the result of stacking more formally as well?}

To reiterate, a fully probabilistic treatment of \Nz\ is equivalent to stacking in the case of accurate delta function \pzpdf s.
A spectroscopic survey under ideal circumstances yields such \pzpdf s.
However, photometric surveys are subject to imprecision and inaccuracy that ensure that ongoing and future missions will not have the kind of \pzpdf s that enable stacking to be valid.
\Sect{chippr:sec:sec:alldata} constrains the response of the stacked estimator to deviations from delta function \pzpdf s and the sensitivity of its validity to realistic violations of the assumption of perfectly informative data.

%\aim{what happens when we deviate away from this assumption of $p(z \mid d_{i}) = \delta(z, z_{i})$?\\
%Figure:\\
%left: rugplot, smoothing/histogram, recover $N(z)$\\
%right: broadening of \zpdf s broadens $N(z)$\\
%in realistic circumstances of photometry being noisy and less informative, stacking is guaranteed to yield an overly broad $N(z)$.}

\subsection{Perfectly uninformative data}
\sectlabel{sec:uninformative}

In \Sect{sec:informative}, we clarified the relationship between the redshift probability and the photometric data and assumed that the \pzpdf s were perfectly informed by the photometry, but that picture is still overly simplistic.
If \pzpdf s were conditioned solely on data, there would be no disagreement about how to derive them from photometric catalogs, because every approach would yield the same result, for which ample counterevidence is presented in \Chap{pzdc1}.
Thus \pzpdf s must be conditioned not only on data unique to each galaxy but also on prior information $\tilde{\theta}$ which corresponds to an interim guess $\tilde{K}$ for $N(z')$ that may come from a template library, a training set, and/or the method by which either of those is combined with the observations.
So, \pzpdf s should be more completely written as $\pr{z \gvn \data_{i}, \tilde{K}}$ making \Eq{eqn:stackwithdata} into
\begin{align}
\eqlabel{eqn:stackwithprior}
\hat{N}(z) &= \sum_{i = 0}^{N} \pr{z \gvn \data_{i}, \tilde{K}} .
\end{align}
If the data were totally uninformative, each galaxy would have the same $\pr{z \gvn \data_{i}, \tilde{K}} = \pr{z \gvn \tilde{K}}$.
Now, we consider what happens to \Eq{eqn:complete} under perfectly uninformative data.

\begin{theorem}
	\label{thm:uninformative}
	The mathematically valid $\langle N(z') \rangle$ asymptotically approaches the result of stacking and the true number $K^{\dagger}$ of galaxies with redshift $z'$ under a special case of perfectly uninformative photometry and perfect prior information $\tilde{K} = K^{\dagger}$.
\end{theorem}
\begin{proof}
	To start, let's update \Eq{eqn:complete} to reflect our new understanding of the role of the prior $\tilde{K}$ in \pzpdf s.
	\begin{align}
	\label{eqn:proofwithprior1}
	\langle N(z') \rangle &= \sum_{K = 0}^{N} K \sum_{j}^{N! / K! (N - K)!} \left[ \prod_{i \in S^{K}_{j}} \pr{z' \gvn \tilde{K}} \prod_{i \in S^{K}_{j}} 1 - \pr{z' \gvn \tilde{K}} \right]
	\end{align}
	If every galaxy has the same \pzpdf, then every galaxy also has the same probability $\pr{z' \gvn \tilde{K}} = \phi = \frac{\tilde{K}}{N}$ for some $\tilde{K}$.
	Without having to worry about the true galaxy redshifts $z^{\dagger}_{i}$, we can very straightforwardly rewrite this in the form of \Eq{eqn:binomial} as
	\begin{align}
	\eqlabel{eqn:proofwithprior2}
	\langle N(z') \rangle &= \sum_{K = 0}^{N} K \sum_{j}^{N! / K! (N - K)!} \left[ \left(\frac{\tilde{K}}{N}\right)^{K} \left(1 - \frac{\tilde{K}}{N}\right)^{N - K} \right] .
	\end{align}
	Since the \pzpdf s are identical to one another, the bracketed terms are the same for a given $K$, meaning each term in the inner sum is the same, so we can eliminate it as 
	\begin{align}
	\eqlabel{eqn:proofwithprior3}
	\langle N(z') \rangle &= \sum_{K = 0}^{N} K \frac{N!}{K! (N - K)!} \left(\frac{\tilde{K}}{N}\right)^{K} \left(1 - \frac{\tilde{K}}{N}\right)^{N - K} .
	\end{align}
	Noting that the first term with $K = 0$ always vanishes, canceling factors of $K$, and factoring out a guess inspired by the coin-flipping analogy, we can rewrite \Eq{eqn:proofwithprior3} as
	\begin{align}
	\eqlabel{eqn:proofwithprior4}
	\langle N(z') \rangle &= N \frac{\tilde{K}}{N} \sum_{K = 1}^{N} \frac{(N - 1)!}{(K - 1)! ((N - 1) - (K - 1))!} \left(\frac{\tilde{K}}{N}\right)^{K - 1} \left(1 - \frac{\tilde{K}}{N}\right)^{(N - 1) - (K - 1)} .
	\end{align}
	From here, we can recursively apply \Eq{eqn:binomial} to yield
	\begin{align}
	\eqlabel{eqn:proofwithprior5}
	\langle N(z') \rangle &= \tilde{K} \left(\frac{\tilde{K}}{N} + 1 - \frac{\tilde{K}}{N}\right)^{N - 1} ,
	\end{align}
	and since the term in parentheses is $1$, we arrive at $\langle N(z') \rangle = \tilde{K}$ for this case.
	The only way for $\langle N(z') \rangle$ to be equal to $K^{\dagger}$ is if $\tilde{K} = K^{\dagger}$, i.e. if the prior were equal to the truth.
\end{proof}

If we stacked such a catalog, we would be taking the average of identical distributions, so $\hat{N}(z) = N \pr{z \gvn \tilde{K}} = \tilde{K}$, the same as the result of Theorem \ref{thm:uninformative}.
Everything thus far has not compared either of these to the true value $K^{\dagger}$ of the redshift distribution.
Indeed, neither can approach the truth unless $\tilde{K} = K^{\dagger}$, i.e. the prior must be the truth in order for stacking to work.
Previous galaxy surveys covered the same limited redshift range and got a thorough sample over the sky to overcome cosmic variance, leading to the use of priors that were representative of the data in the regime where they were applied.
However, at higher redshifts or in atypical galaxy environments, we will not be able to count on a lucky guess of $\tilde{K} \approx K^{\dagger}$.
Without knowing truth sufficiently well to use it as a prior, we will instead have to rely on imperfect data.
%\aim{Figure: sum of same $N_{z}$ building up to that times $N_{tot}$}
The sensitivity of the stacked estimator of the redshift distribution to deviations from this assumption is explored in \Sect{chippr:sect:sec:interim}.

\section{Conclusion}
\sectlabel{sec:disco}

\aim{Discuss the limit of $N\to\infty$.
Doesn't the binomial stuff become Poisson, so I can write it differently?}

This \paper conducts an investigation of the sleight of hand that enables the thoroughly unmotivated Equation~\ref{intro:eq:eqn:stack} to masquerade as an acceptable approximation to the provably correct but computationally intractable \Eq{eqn:complete}.
The preceding proofs show not only the most complete and correct way to frame the redshift distribution \Nz, but they also address the question of how stacking can fool even clever astrophysicists into thinking it works.

The only cases in which stacking works are when the \pzpdf s are perfect or when the prior information is perfect.
%when the right procedure is equivalent to stacking, but in that final case, it only approaches the true $\textbf{N}_{z}$ when $\tilde{n}(z) = \frac{\textbf{N}_{z}}{N_{tot}}$, i.e. when the truth is already known and baked into the PDFs.\\
While it is possible to imagine some conspiracy between informative and uninformative \pzpdf s that enables stacking to work, such a solution would be very finely tuned and thus not generally achievable, out of the many, many possible \pzpdf\ catalogs.

Though the conditions of \Sect{sec:informative} and \Sect{sec:uninformative} may not have been strongly violated in the past, they will be nowhere near satisfied for ongoing and upcoming surveys.
Note that if those conditions held, we would not need \lsst\ at all.
Thus, we must not stack!
\aim{Maybe beef up this section to tie in to cosmology.}

%\section*{Notation}
%\sectlabel{sec:notation}
%
%\begin{table*}
%	\begin{center}
%		\begin{tabular}{ll}
%			$X'$ & a particular value of $X$\\
%			$\lnot X'$ & any value of $X$ other than $X'$\\
%			$X^{\dagger}$ & the true value of $X$\\
%			$\hat{X}$ & an estimated value of $X$\\ 
%			$\Omega(X)$ & the space of all possible values of $X$\\
%			$[N]^{K}$ & all possible sets of $K$ events chosen from $N$ possible events\\
%			$|S|$ & the number of elements of set $S$\\
%		\end{tabular}
%	\caption{
%		Glossary of important symbols used in this Chapter.
%		\aim{Did I miss anything?}
%		}
%	\tablabel{tab:glossary}
%	\end{center}
%\end{table*}

\section*{Chapter acknowledgements}

I thank David Alonso, Johann Cohen-Tanugi, Daniel Gruen, Will Hartley, Alan Heavens, Mike Jarvis, Boris Leistedt, Tom Loredo, Rachel Mandelbaum, Mark Manera, Phil Marshall, Jeff Newman, Eduardo Rozo, and Josh Speagle for helpful conversations that inspired this work and for feedback as it developed.